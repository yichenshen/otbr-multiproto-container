# OpenThread Border Router Container for Silabs Multiprotocol

This is Silabs' forked OpenThread Border Router (otbr) for [multiprotocol support via CPCd](https://docs.silabs.com/openthread/latest/multiprotocol-solution-linux/building-otbr-locally) in a container.

This version of otbr can connect via cpc instead of directly via the device interface, allowing the device to be used for other protocols via [CPCd](https://github.com/SiliconLabs/cpc-daemon) like Zigbee. It can be paired directly with a [CPCd container](https://github.com/yichenshen/cpcd-container) as well.

## Setup

### Options

The same environment vars used for the [upstream](https://openthread.io/guides/border-router/build-docker) otbr container are supported here too:

- OT_RCP_DEVICE: Specifies the connection to the Thread Radio Co-Processor (RCP).
  - Default: `'spinel+cpc://cpcd_0?iid=2&iid-list=0'`
- OT_INFRA_IF: The network interface used for the adjacent infrastructure network (typically Wi-Fi or Ethernet).
  - Default: `eth0`
- OT_THREAD_IF: The network interface name used for the Thread network.
  - Default: `wpan0`
- OT_LOG_LEVEL: The verbosity level of logs generated by OpenThread.
  - Default: `3`

## Running

### For testing

```bash
sudo podman run --name=otbr -it --rm --privileged --network=host -v /run/dbus:/run/dbus:rw -v /dev/shm:/dev/shm:rw -v /etc/localtime:/etc/localtime:ro --device=/dev/net/tun oghcr.io/yichenshen/otbr-multiproto-container:latest
```

> Note that you need CPCd running when running with the default, which connects via CPC

> Also note that otbr requires a fair bit of privileges (rootful + network=host) because it needs to create and manage the Thread interface wpan0

### Quadlet

The default quadlet file can be installed to the root's systemd folder to run otbr with systemd. As per above, this has to be `/etc/containers/systemd/` as the container needs to be rootful.

```bash
sudo cp otbr-multiproto.container /etc/containers/systemd/
sudo systemctl daemon-reload
sudo systemctl enable otbr-multiproto
sudo systemctl start otbr-multiproto
```

> The quadlet mounts 2 volumes, otbr-run and otbr-data. The former contains the otbr sockets, and can be mounted on another otbr-multiproto container to use the web GUI or ot-cli (see below) on the instance. The later stores Thread configuration data to be persisted between restarts.

### Routing

otbr by default creates routes with metric 256. This is somewhat awkward. It is higher then other advertised routes say from Google's Nest Hub (105), but lower than the systemd-networkd (1024). As such, it doesn't route Thread addresses to itself but instead routes `fe80::`. It's advisable to adjust the metric so routing behaves as expected.

For example if your Thread IP prefix is `fdae:3c84:2ad6:1`:

```bash
sudo ip -6 route del fdae:3c84:2ad6:1::/64 dev wpan0
sudo ip -6 route replace fdae:3c84:2ad6:1::/64 dev wpan0 metric 64
sudo ip -6 route del fe80::/64 dev wpan0
sudo ip -6 route replace fe80::/64 dev wpan0 metric 2048
```

The quadlet container will do this after start automatically.

## License

See the [LICENSE](LICENSE.md) file for license rights and limitations (MIT).
